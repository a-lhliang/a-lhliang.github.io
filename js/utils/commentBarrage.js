function initializeCommentBarrage(){if(window.commentBarrageInitialized)return;window.commentBarrageInitialized=!0;let e={maxBarrage:1,barrageTime:8e3,twikooUrl:"https://twikoo-v.lhliang.com",accessToken:"e3fde5ee4bc1bb8c5021357dfbea59b6",pageUrl:window.location.pathname};new class{constructor(e){this.config={...e,barrageTimer:[],barrageList:[],barrageIndex:0,dom:document.querySelector(".comment-barrage")},this.commentInterval=null,this.hoverOnCommentBarrage=!1,this.init()}async fetchComments(){return fetch(this.config.twikooUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:"COMMENT_GET",accessToken:this.config.accessToken,url:this.config.pageUrl})}).then((e=>{if(!e.ok)throw Error("HTTP error! status: "+e.status);return e.json()})).then((e=>e.data)).catch((e=>console.error("An error occurred while fetching comments: ",e)))}commentLinkFilter(e){e.sort(((e,t)=>e.created-t.created));let t=[];return e.forEach((e=>{t.push(...this.getCommentReplies(e))})),t}getCommentReplies(e){if(e.replies){let t=[e];return e.replies.forEach((e=>{t.push(...this.getCommentReplies(e))})),t}return[]}processCommentContent(e){const t=e.replace(/<blockquote\b[^>]*>[\s\S]*?<\/blockquote>/gi,""),r=t.replace(/<[^>]*>/g,"").replace(/\n/g," ");return""===t.trim()?"":`<p>${r}</p>`}popCommentBarrage(e){var t=this.processCommentContent(e.comment);if(!t.trim())return!1;let r=document.createElement("div");return r.className="comment-barrage-item",r.innerHTML=`\n        <div class="barrageHead">\n            <a class="barrageTitle" href="javascript:LHL.scrollTo('post-comment')"">热评</a>\n            <div class="barrageNick">${e.nick}</div>\n            <img class="barrageAvatar" src="https://cravatar.cn/avatar/${e.mailMd5}" alt="热评头像"/>\n            <a class="comment-barrage-close" href="javascript:LHL.switchCommentBarrage();"><i class="lhlfont icon-close"></i></a>\n        </div>\n        <a class="barrageContent" href="javascript:LHL.scrollTo('${e.id}');">${t}</a>\n      `,this.config.barrageTimer.push(r),this.config.dom.append(r),!0}removeCommentBarrage(e){e.className="comment-barrage-item out",setTimeout((()=>{this.config.dom.removeChild(e)}),1e3)}initCommentBarrage(){"false"!==localStorage.getItem("commentBarrageSwitch")?($(".comment-barrage").show(),$(".menu-commentBarrage-text").text("关闭热评"),document.querySelector("#consoleCommentBarrage").classList.add("on")):($(".comment-barrage").hide(),$(".menu-commentBarrage-text").text("显示热评"),document.querySelector("#consoleCommentBarrage").classList.remove("on")),this.fetchComments().then((e=>{this.config.barrageList=this.commentLinkFilter(e),this.config.dom.innerHTML="",clearInterval(this.commentInterval),this.commentInterval=null;const t=()=>{if(this.config.barrageList.length&&!this.hoverOnCommentBarrage){if(!this.popCommentBarrage(this.config.barrageList[this.config.barrageIndex]))return this.config.barrageIndex+=1,this.config.barrageIndex%=this.config.barrageList.length,void t();this.config.barrageIndex+=1,this.config.barrageIndex%=this.config.barrageList.length}this.config.barrageTimer.length>(this.config.barrageList.length>this.config.maxBarrage?this.config.maxBarrage:this.config.barrageList.length)&&!this.hoverOnCommentBarrage&&this.removeCommentBarrage(this.config.barrageTimer.shift())};setTimeout((()=>{t(),this.commentInterval&&clearInterval(this.commentInterval),this.commentInterval=setInterval(t,this.config.barrageTime)}),3e3)}))}init(){this.initCommentBarrage(),$(".comment-barrage").hover((()=>{this.hoverOnCommentBarrage=!0,console.log("热评悬浮")}),(()=>{this.hoverOnCommentBarrage=!1,console.log("停止悬浮")}))}}(e)}initializeCommentBarrage();